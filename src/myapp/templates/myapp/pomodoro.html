<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ç•ªèŒ„é’Ÿ | ä¸“æ³¨å·¥ä½œæ³•</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { background: white; border-radius: 20px; padding: 30px; width: 100%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        h1 { color: #333; text-align: center; margin-bottom: 10px; }
        .subtitle { color: #666; text-align: center; margin-bottom: 30px; font-size: 0.9rem; }
        .timer-display { font-size: 5rem; font-weight: bold; text-align: center; color: #4a5568; margin: 20px 0; }
        .status { text-align: center; padding: 8px; border-radius: 50px; margin: 15px auto; width: fit-content; font-size: 0.9rem; }
        .status.planned { background: #e2e8f0; color: #4a5568; }
        .status.working { background: #c6f6d5; color: #22543d; }
        .status.paused { background: #fed7d7; color: #742a2a; }
        .controls { display: flex; justify-content: center; gap: 10px; margin: 25px 0; flex-wrap: wrap; }
        button { padding: 12px 24px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .btn-start { background: #38a169; color: white; }
        .btn-pause { background: #dd6b20; color: white; }
        .btn-leave { background: #e53e3e; color: white; }
        .btn-resume, .btn-complete { background: #3182ce; color: white; }
        .btn-reset { background: #a0aec0; color: white; }
        button:hover { opacity: 0.9; transform: translateY(-2px); }
        button:disabled { background: #cbd5e0; cursor: not-allowed; transform: none; }
        .stats { background: #f7fafc; border-radius: 10px; padding: 20px; margin-top: 25px; }
        .stats h3 { color: #4a5568; margin-bottom: 10px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .debug-info { background: #edf2f7; padding: 15px; border-radius: 10px; margin-top: 20px; font-size: 0.8rem; color: #718096; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ… æˆ‘çš„ç•ªèŒ„é’Ÿ</h1>
        <p class="subtitle">ä¸“æ³¨å·¥ä½œæ³• Â· è®°å½•æœ‰æ•ˆæ—¶é•¿</p>

        <div class="timer-display" id="timerDisplay">25:00</div>

        <div class="status planned" id="statusIndicator">çŠ¶æ€ï¼šè®¡åˆ’ä¸­</div>

        <div class="controls">
            <button class="btn-start" onclick="startTomato()" id="btnStart">å¼€å§‹ä¸“æ³¨</button>
            <button class="btn-pause" onclick="pauseTomato()" id="btnPause" disabled>æš‚åœ</button>
            <button class="btn-leave" onclick="startLeave()" id="btnLeave" disabled>æˆ‘è¦æš‚ç¦»</button>
            <button class="btn-resume" onclick="endLeave()" id="btnResume" disabled>ç»“æŸæš‚ç¦»</button>
            <button class="btn-complete" onclick="completeTomato()" id="btnComplete" disabled>å®Œæˆç•ªèŒ„</button>
            <button class="btn-reset" onclick="resetTomato()" id="btnReset">é‡ç½®</button>
        </div>

        <div class="stats">
            <h3>ğŸ“Š æœ¬æ¬¡ä¼šè¯ç»Ÿè®¡</h3>
            <div class="stat-row"><span>è®¡åˆ’æ—¶é•¿ï¼š</span><span id="statPlanned">25</span> åˆ†é’Ÿ</div>
            <div class="stat-row"><span>æœ‰æ•ˆå·¥ä½œæ—¶é•¿ï¼š</span><span id="statEffective">0</span> åˆ†é’Ÿ</div>
            <div class="stat-row"><span>æš‚ç¦»æ—¶é•¿ï¼š</span><span id="statLeave">0</span> åˆ†é’Ÿ</div>
            <div class="stat-row"><span>ä¼šè¯çŠ¶æ€ï¼š</span><span id="statStatus">è®¡åˆ’ä¸­</span></div>
        </div>

        <!-- å¼€å‘é˜¶æ®µç”¨äºè°ƒè¯•å’ŒAPIæµ‹è¯• -->
        <div class="debug-info">
            <strong>å¼€å‘æ¨¡å¼</strong><br>
            å½“å‰ä¼šè¯ID: <span id="sessionId">æ— </span><br>
            <button onclick="testCreateSession()">æµ‹è¯•åˆ›å»ºä¼šè¯</button>
            <button onclick="testUpdateSession()">æµ‹è¯•æ›´æ–°ä¼šè¯</button>
            <button onclick="loadAllSessions()">æŸ¥çœ‹æ‰€æœ‰è®°å½•</button>
            <pre id="apiResponse"></pre>
        </div>
    </div>

    <script>
        // 1. æ ¸å¿ƒçŠ¶æ€ä¸é…ç½®ï¼ˆè§£è€¦ï¼šçŠ¶æ€ç®¡ç†ç‹¬ç«‹ï¼‰
        let appState = {
            sessionId: null,
            status: 'planned', // planned, working, paused, completed
            plannedMinutes: 25,
            timerInterval: null,
            remainingSeconds: 25 * 60,
            leaveStartTime: null
        };

        // 2. å·¥å…·å‡½æ•°ï¼ˆè§£è€¦ï¼šçº¯å‡½æ•°ï¼Œæ— å‰¯ä½œç”¨ï¼‰
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateDisplay() {
            document.getElementById('timerDisplay').textContent = formatTime(appState.remainingSeconds);
            document.getElementById('statEffective').textContent = (appState.plannedMinutes * 60 - appState.remainingSeconds) / 60;
            document.getElementById('statStatus').textContent = getStatusText(appState.status);
        }

        function getStatusText(status) {
            const map = { 'planned': 'è®¡åˆ’ä¸­', 'working': 'ä¸“æ³¨ä¸­', 'paused': 'æš‚ç¦»ä¸­', 'completed': 'å·²å®Œæˆ' };
            return map[status] || status;
        }

        // 3. æ ¸å¿ƒæ§åˆ¶é€»è¾‘ï¼ˆè§£è€¦ï¼šæ¯ä¸ªåŠŸèƒ½ç‚¹ç‹¬ç«‹ï¼‰
        function startTomato() {
            if (appState.status !== 'planned') return;
            appState.status = 'working';
            appState.remainingSeconds = appState.plannedMinutes * 60;
            startTimer();
            updateUI();
            // è¿™é‡Œå°†æ¥ä¼šè°ƒç”¨APIï¼šåˆ›å»ºæ–°çš„TomatoSession
            console.log('å¼€å§‹ç•ªèŒ„é’Ÿï¼Œåˆ›å»ºä¼šè¯');
        }

        function pauseTomato() {
            if (appState.status !== 'working') return;
            appState.status = 'planned';
            stopTimer();
            updateUI();
            console.log('æš‚åœç•ªèŒ„é’Ÿ');
        }

        function startLeave() {
            if (appState.status !== 'working') return;
            appState.status = 'paused';
            appState.leaveStartTime = new Date();
            stopTimer();
            updateUI();
            console.log('å¼€å§‹æš‚ç¦»', appState.leaveStartTime);
        }

        function endLeave() {
            if (appState.status !== 'paused') return;
            appState.status = 'working';
            const leaveDuration = Math.floor((new Date() - appState.leaveStartTime) / 1000);
            // è¿™é‡Œå°†æ¥ä¼šè°ƒç”¨APIï¼šæ›´æ–°ä¼šè¯çš„leave_start_atå’Œleave_end_at
            console.log('ç»“æŸæš‚ç¦»ï¼Œç¦»å¼€æ—¶é•¿:', leaveDuration, 'ç§’');
            appState.leaveStartTime = null;
            startTimer();
            updateUI();
        }

        function completeTomato() {
            appState.status = 'completed';
            stopTimer();
            updateUI();
            // è¿™é‡Œå°†æ¥ä¼šè°ƒç”¨APIï¼šæ ‡è®°ä¼šè¯ä¸ºå®Œæˆ
            console.log('å®Œæˆç•ªèŒ„é’Ÿ');
        }

        function resetTomato() {
            appState.status = 'planned';
            appState.remainingSeconds = appState.plannedMinutes * 60;
            appState.leaveStartTime = null;
            stopTimer();
            updateUI();
            console.log('é‡ç½®ç•ªèŒ„é’Ÿ');
        }

        // 4. å®šæ—¶å™¨æ§åˆ¶ï¼ˆè§£è€¦ï¼šç‹¬ç«‹æ¨¡å—ï¼‰
        function startTimer() {
            stopTimer(); // ç¡®ä¿åªæœ‰ä¸€ä¸ªå®šæ—¶å™¨
            appState.timerInterval = setInterval(() => {
                if (appState.remainingSeconds > 0) {
                    appState.remainingSeconds--;
                    updateDisplay();
                } else {
                    completeTomato();
                }
            }, 1000);
        }

        function stopTimer() {
            if (appState.timerInterval) {
                clearInterval(appState.timerInterval);
                appState.timerInterval = null;
            }
        }

        // 5. UIçŠ¶æ€åŒæ­¥ï¼ˆè§£è€¦ï¼šè§†å›¾æ›´æ–°ç‹¬ç«‹ï¼‰
        function updateUI() {
            const statusText = getStatusText(appState.status);
            document.getElementById('statusIndicator').textContent = `çŠ¶æ€ï¼š${statusText}`;
            document.getElementById('statusIndicator').className = `status ${appState.status}`;

            // æŒ‰é’®çŠ¶æ€æœº
            document.getElementById('btnStart').disabled = appState.status !== 'planned';
            document.getElementById('btnPause').disabled = appState.status !== 'working';
            document.getElementById('btnLeave').disabled = appState.status !== 'working';
            document.getElementById('btnResume').disabled = appState.status !== 'paused';
            document.getElementById('btnComplete').disabled = appState.status === 'completed';
            document.getElementById('btnReset').disabled = false;

            updateDisplay();
        }

        // 6. APIäº¤äº’æ¨¡æ‹Ÿï¼ˆè§£è€¦ï¼šä¸ºåç«¯é›†æˆé¢„ç•™æ¥å£ï¼‰
        function testCreateSession() {
            fetch('/api/tomato/create/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                body: JSON.stringify({ planned_duration: appState.plannedMinutes })
            })
            .then(response => response.json())
            .then(data => {
                appState.sessionId = data.id;
                document.getElementById('sessionId').textContent = data.id;
                document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
            });
        }

        function getCsrfToken() {
            return document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';
        }

        // åˆå§‹åŒ–
        updateUI();
    </script>
</body>
</html>